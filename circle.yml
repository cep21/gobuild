machine:
  environment:
    GOLANG_VERSION: 1.5.1
    GO15VENDOREXPERIMENT: 1
    GOROOT: /usr/local/go
    GOPATH: "$HOME/.go"
    CACHED_LINT_TOOLS_DIR: "$HOME/lints"
    PATH: "$GOROOT/bin:$GOPATH/bin:$HOME/circleutil/scripts:$CACHED_LINT_TOOLS_DIR:$PATH"
    IMPORT_PATH: "github.com/cep21/gobuild"
    SRC_PATH: "$GOPATH/src/$IMPORT_PATH"

checkout:
  post:
    - git clone github.com/cep21/circleutil $HOME/circleutil

# TODO: Cache this if it exists???
dependencies:
  cache_directories:
    # All the versions of 'go' go here.
    - /usr/local/gover
  override:
    - install_all_go_versions.sh
    - install_lint_tools.sh
    - remove_useless_cache_dirs.sh

test:
  override:
    - copy_local_code_to_gopath.sh
    - cd $SRC_PATH && go test .
    - cd $SRC_PATH && go build . && ./gobuild -verbose

deployment:
  release:
    tag: /v[0-9]+(\.[0-9]+)*/
    owner: cep21
    commands:
      - deploy_distributions.sh
